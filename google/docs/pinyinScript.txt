/**
 * @OnlyCurrentDoc
 *
 * The above comment directs Apps Script to limit the scope of file access for
 * this add-on to the current doc. The authorization request message presented
 * to users will reflect this limited scope.
 */

/** Add pinyin options to document menu. */
function onOpen() {
  var ui = DocumentApp.getUi();
  ui.createMenu('Pinyin')
      .addItem('mdzs', 'mdzs')
      .addItem('guardian', 'guardian')
      .addToUi();
}

/**
 * Returns a regex string to match a sequence of words, allowing an optional
 * dash (-) or space ( ) between each word. The beginning and end of the
 * matching sequence must be at a word boundary.
 */
function wordsMatchRegex(words) {
  return '\\b(' + words.join('( |-)?') + ')\\b';
}

/**
 * Returns a regex string to match a sequence of words, case-insensitively. See
 * wordsMatchRegex for more info.
 */
function wordsMatchIgnoreCaseRegex(words) {
  return '((?i)(' + wordsMatchRegex(words) + '))';
}

/**
 * Hard-coded MDZS pinyin replacement rules.
 */
function mdzsReplacements() {
  // For each line 'some text here|fancy replacement', replaces all instances of
  // 'some text here' in the doc with 'fancy replacement'.
  // Notes:
  //  * capitalization on the left side is ignored
  //  * any spaces on the left side that are between words will matching things
  //    with
  //    (a) no space there (b) a dash there or (c) a space there. Examples:
  //      - 'hanguang jun|Hánguāng-jūn' means any of 'hanguang jun',
  //        'hanguangjun', or 'hanguang-jun' will be replaced with
  //        'Hánguāng-jūn'
  //      - 'wen ke xing|Wēn Kèxíng' means that all of 'Wen KeXing', 'Wen Ke
  //        Xing', and 'wen kexing' will be replaced with 'Wēn Kèxíng'
  //  * any spaces on the left or right that are before all words or after all
  //    words will be ignored
  //  * partial-word matches will be ignored (e.g., if 'lan' is part of 'plan'
  //    or 'land' it will not be replaced; if 'lan sect' is part of 'plan sect'
  //    it will not be replaced)
  //  * lines with only spaces on them, or that start with #, will be ignored.
  return `
      # Yunmeng Jiang Sect and related stuff
      ## Wei Ying (魏婴 Wèi Yīng), courtesy name Wei Wuxian (魏无羡, Wèi Wúxiàn) and his title Yiling Patriarch (夷陵老祖, Yílíng Lǎozǔ)
      wei ying|Wèi Yīng
      wei wuxian|Wèi Wúxiàn
      wy|Wèi Yīng
      wwx|Wèi Wúxiàn
      a xian|Ā-Xiàn
      young master wei|Young Master Wèi
      yiling patriarch|Yílíng Patriarch
      yiling laozu|Yílíng Lǎozǔ
      yiling|Yílíng
      laozu|Lǎozǔ
      wei|Wèi
      wuxian|Wúxiàn
      ## Jiang Cheng (江澄 Jiāng Chéng), courtesy name Jiang Wanyin (江晚吟 Jiāng Wǎnyín), and his title Sandu Shengshou (三毒圣手 Sāndú shèngshǒu)
      jiang cheng|Jiāng Chéng
      a cheng|Ā-Chéng
      sandu shengshou|Sāndú Shèngshǒu
      sandu|Sāndú
      shengshou|Shèngshǒu
      wanyin|Wǎnyín
      ## Yu Ziyuan (虞紫鸢, Yú Zǐyuān) and title Madam Yu (虞夫人, Yú fūrén) and the Violet Spider (紫蜘蛛, Zǐ Zhīzhū).
      yu ziyuan|Yú Zǐyuān
      yu furen|Yú fūrén
      madame yu|Madame Yú
      zi zhizhu|Zǐ Zhīzhū
      ziyuan|Zǐyuān
      ## Jiang Fengmian (江枫眠, Jiāng Fēngmián)
      jiang fengmian|Jiāng Fēngmián
      fengmian|Fēngmián
      ## Jiang Yanli (江厌离, Jiāng Yànlí)
      jiang yanli|Jiāng Yànlí
      yanli|Yànlí
      ## hmmmmmm technically this could also be the unit "a li" (~.5 km), so maybe remove
      a li|Ā-Lí
      ## Zidian (紫电, Zǐdiàn), Chenqing  陈情 Chén qíng, Suibian 随便 Suíbiàn
      zidian|Zǐdiàn
      chenqing|Chénqíng
      suibian|Suíbiàn
      ## Yunmeng Jiang Sect (云梦江氏, Yúnmèng Jiāng Shì)
      sect leader jiang|Sect Leader Jiāng
      yunmeng jiang shi|Yúnmèng Jiāng Shì
      yunmeng|Yúnmèng
      jiang|Jiāng
      
      # Lanling Jin Sect
      ## Jin Zixuan (金子轩, Jīn Zixuān)
      jin zixuan|Jīn Zixuān
      zixuan|Zixuān
      ## Jin Ling (金凌, Jīn Líng), courtesy name Jin Rulan (金如兰, Jīn Rúlán)
      jin ling|Jīn Líng
      a ling|Ā-Líng
      jin rulan|Jīn Rúlán
      rulan|Rúlán
      ## Jin Guangshan (金光善, Jīn Guāngshàn)
      jin guangshan|Jīn Guāngshàn
      ## Jin Guangyao (金光瑶, Jīn Guāngyáo), birth name Meng Yao (孟瑶, Mèng Yáo)
      jin guangyao|Jīn Guāngyáo
      guangyao|Guāngyáo
      meng yao|Mèng Yáo
      a yao|Ā-Yáo
      ## Mo Xuanyu (莫玄羽, Mò Xuányǔ)
      mo xuanyu|Mò Xuányǔ
      xuanyu|Xuányǔ
      senior mo|Senior Mò
      ## Mian Mian (Chinese: 绵绵; Miánmián)
      mian mian|Miánmián
      luo qingyang|Luó Qīngyáng
      qingyang|Qīngyáng
      ## Other
      jin zixun|Jīn Zixūn
      zixun|Zixūn
      ## Carp Tower (金鳞台, Jīnlín Tái; also: Koi Tower, Jinlin Tower)
      jin lin tower|Jīnlín Tower
      jin lin tai|Jīnlín Tái
      ## Lanling Jin Sect (兰陵金氏, Lánlíng Jīn Shì)
      langling jin shi|Lánlíng Jīn Shì
      langling jin|Lánlíng Jīn
      lanling|Lánlíng
      jin|Jīn
      
      # Gusu Lan Sect
      ## Lan Zhan (蓝湛 Lán Zhàn), courtesy name Lan Wangji (蓝忘机, Lán Wàngjī) , and title Hanguang-Jun (含光君, Hánguāng-jūn),
      lan zhan|Lán Zhàn
      zhan|Zhàn
      lan wang ji|Lán Wàngjī
      lwj|Lán Wàngjī
      wangji|Wàngjī
      hanguang jun|Hánguāng-jūn
      master lan|Master Lán
      ## Lan Qiren (蓝启仁, Lán Qǐrén)
      lan qiren|Lán Qǐrén
      qiren|Qǐrén
      ## Lan Huan (蓝涣, Lán Huàn), courtesy name Lan Xichen (蓝曦臣, Xīchén) and title Zewu-Jun (泽芜君, Zéwú-jūn)
      lan huan|Lán Huàn
      lan xichen|Lán Xīchén
      xichen|Xīchén
      zewu jun|Zéwú-jūn
      ## Lan Yuan (蓝愿, Lán yuàn) courtesy name Lan Sizhui (思追, Lán Sīzhuī) and born Wen Yuan (温苑, Wēn yuàn)
      lan yuan|Lán Yuàn
      a yuan|Ā-Yuàn
      lan sizhui|Lán Sīzhuī
      sizhui|Sīzhuī
      wen yuan|Wēn Yuàn
      ## Lan Jingyi (蓝景仪, Lán Jǐngyí)
      lan jingyi|Lán Jǐngyí
      jingyi|Jǐngyí
      ## Caiyi Town (彩衣城, Cǎiyī Chéng)
      caiyi town|Cǎiyī Town
      caiyi cheng|Cǎiyī Chéng
      ## Jìngshì (静室, jìng shì)
      jingshi|Jìngshì
      ## Bichen (避尘, Bìchén)
      bichen|Bìchén
      ## Gusu Lan Sect (姑苏蓝氏, Gūsū Lán Shì), Gusu (姑苏, Gūsū)
      gusu lan shi|Gūsū Lán Shì
      gusu lan|Gūsū Lán
      # don't match lan|Lán because we might miss Song Lan
      gusu|Gūsū
      
      # Qinghe Nie Sect
      ## Nie Huaisang (聂怀桑, Niè Huáisāng)
      nie huaisang|Niè Huáisāng
      huaisang|Huáisāng
      ## Nie Mingjue (聂明玦, Niè Míngjué)
      nie mingjue|Niè Míngjué
      mingjue|Míngjué
      ## Other
      nie zonghui|Niè Zōnghuī
      zonghui|Zōnghuī
      ## Qinghe Nie Sect (清河聂氏, Qīnghé Niè Shì)
      qinghe nie shi|Qīnghé Niè Shì
      qinghe nie|Qīnghé Niè
      qinghe|Qīnghé
      nie|Niè
      
      # Qishan Wen Sect
      ## Wen Ning (温宁, Wēn Níng), courtesy name Qionglin (温琼林, Qiónglín)  Known as the Ghost General (鬼将军, Guǐ jiāngjūn)
      Wen Ning|Wēn Níng
      Wen Qionglin|Wēn Qiónglín
      Qionglin|Qiónglín
      Gui Jiangjun|Guǐ jiāngjūn
      ## Wen Qing (温情, Wēn Qíng)
      Wen Qing|Wēn Qíng
      ## Wen Ruohan (温若寒, Wēn Ruòhán)
      Wen Ruohan|Wēn Ruòhán
      ## Wen Chao (温晁, Wēn Cháo)
      Wen Chao|Wēn Cháo
      ## Wen Xu (温旭, Wēn Xù)
      Wen Xu|Wēn Xù
      ## Wen Zhuliu (Wēn Zhúliú 温逐流)
      Wen Zhu Liu|Wēn Zhúliú
      Zhu Liu|Zhúliú
      ## Qishan Wen Sect (岐山温氏, Qíshān Wēn Shì)
      Qishan Wen Shi|Qíshān Wēn Shì
      Qishan Wen|Qíshān Wēn
      Qishan|Qíshān
      Da Fan Wen|Dàfàn Wēn
      Wen|Wēn
      
      # misc people
      ## Song Lan (宋岚, Sòng Lán), courtesy name Song Zichen (宋子琛)
      Song Lan|Sòng Lán
      Song Zichen|Sòng Zichēn
      Zichen|Zichēn
      ## Fuxue (拂雪, Fúxuě)
      Fuxue|Fúxuě
      ## Xiao Xingchen (晓星尘, Xiǎo Xīngchén)
      Xiao Xingchen|Xiǎo Xīngchén
      Xingchen|Xīngchén
      ## Shuanghua (霜华, Shuānghuá)
      Shuanghua|Shuānghuá
      ## Xue Yang (薛洋, Xuē Yáng)
      Xue Yang|Xuē Yáng
      ## Baoshan Sanren (抱山散人, Bàoshān sànrén)
      Baoshan Sanren|Bàoshān Sànrén
      ## Cangse Sanren (藏色散人, Cángsè Sànrén)
      Cangse Sanren|Cángsè Sànrén
      Zangse Sanren|Zángsè Sànrén
      ## Ouyang Zizhen (欧阳子真 Ōuyáng Zizhēn)
      Ouyang Zizhen|Ōuyáng Zizhēn
      
      # misc other
      ## gongzi (公子, gōngzī)
      Gongzi|gōngzī
      ## guqin ( Chinese: 古琴;  pinyin: gǔqín)
      Guqin|gǔqín
      ## Yi City (Chinese: 义城; pinyin: Yì chéng)
      Yi City|Yì City
      Yi Cheng|Yì Chéng
      ## Dafan Mountain (大梵山, Dà fàn shān)
      Da Fan Mountain|Dàfàn Mountain
      Da Fan Shan|Dàfàn shān
      ## 大哥 dà gē
      da ge|dàgē
      ## ge (Chinese: 哥; pinyin: gē)
      -Ge|-gē
      ## Gege (Chinese: 哥哥; pinyin: Gégé)
      Gege|gēge
      ## xiōngzhǎng 兄长
      xiong zhang|Xiōngzhǎng
      ## xiong (兄 Xiōng)
      -Xiong|-xiōng
      ## Jiejie (Chinese: 姐姐, Jiějiě)
      Jiejie|jiějiě
      ## shī jiě 师姐
      Shijie|shījiě
      ## Jie (Chinese: 姐, Jiě)
      -Jie|-jiě
      ## qiánkūn dài 乾坤袋 (Qiankun bag)
      qiankun dai|qiánkūn dài
      qiankun|qiánkūn
      ## Jìngshì 静室 - LWJ’s room
      jingshi|Jìngshì
      ## Hánshì 寒室 - LXC’s room
      hanshi|Hánshì
      ## Míngshì 冥室 - Building where they do summonings
      mingshi|Míngshì
      ## Yǎshì 雅室 - For receiving visitors
      yashi|Yǎshì
      ## Lánshì 兰室 - Classroom
      lanshi|lanshi

  
      # attempt to match lan|Lán at the end, after conflict with Song Lan doesn't matter
      lan|Lán
      `;
}

/**
 * Hard-coded Guardian pinyin replacement rules.
 */
function guardianReplacements() {
  // For each line 'some text here|fancy replacement', replaces all instances of
  // 'some text here' in the doc with 'fancy replacement'.
  // Notes:
  //  * capitalization on the left side is ignored
  //  * any spaces on the left side that are between words will matching things
  //    with
  //    (a) no space there (b) a dash there or (c) a space there. Examples:
  //      - 'hanguang jun|Hánguāng-jūn' means any of 'hanguang jun',
  //        'hanguangjun', or 'hanguang-jun' will be replaced with
  //        'Hánguāng-jūn'
  //      - 'wen ke xing|Wēn Kèxíng' means that all of 'Wen KeXing', 'Wen Ke
  //        Xing', and 'wen kexing' will be replaced with 'Wēn Kèxíng'
  //  * any spaces on the left or right that are before all words or after all
  //    words will be ignored
  //  * partial-word matches will be ignored (e.g., if 'lan' is part of 'plan'
  //    or 'land' it will not be replaced; if 'lan sect' is part of 'plan sect'
  //    it will not be replaced)
  //  * lines with only spaces on them, or that start with #, will be ignored.
  return `
      # guardian
      ## Zhao Yunlan (赵云澜 / 趙云瀾, Zhào Yúnlán)
      Chief Zhao|Chief Zhào
      Zhao Yun Lan|Zhào Yúnlán
      Yunlan|Yúnlán
      ## in the past: Kunlan Kūnlún | 昆仑
      Kunlun|Kūnlún
      ## Shen Wei (沈巍	Shěn Wēi) or Xiao Wei Xiǎo Wēi 小巍
      Shen Wei|Shěn Wēi
      Professor Shen|Professor Shěn
      Hei Pao Shi|Hēi Páo Shǐ
      Xiao Wei|Xiǎo Wēi")
      ## Zhao Xinci (赵心慈	Zhào Xīncí)
      Zhao Xin Ci|Zhào Xīncí
      ## Guo Ying 郭英 Guō Yīng
      Guo Ying|Guō Yīng
      ## Guo Changcheng 郭长城 Guō Chángchéng
      Guo Chang Cheng|Guō Chángchéng
      ## Zhu Hong 祝红 Zhù hóng
      Zhu Hong|Zhù Hóng
      ## Da Qing 大庆 Dàqìng
      Da Qing|Dà Qìng
      ## Chu Shuzhi 楚恕之 Chǔ shù zhī
      Chu Shu Zhi|Chǔ Shùzhī
      ## Wang Zheng 汪徵 Wāng zhēng
      Wang Zheng|Wāng Zhēng
      ## Lin Jing 林静 Lín Jìng
      Lin Jing|Lín Jìng
      ## Sang Zan 桑赞 Sāng Zàn
      Sang Zan|Sāng Zàn
      ## Old Li 老李 lǎo Lǐ Old Lǐ
      Old Li|Old Lǐ
      Lao Li|Lǎo Lǐ
      ## Ye Zun 夜尊 Yè Zūn
      Ye Zun|Yè Zūn
      ## Zhu Jiu 烛九 Zhú jiǔ
      Zhu Jiu|Zhú jiǔ
      ## Ya Qing 鸦青 Yā Qīng
      Ya Qing|Yā Qīng
      ## Sha Ya 沙雅 Shā Yǎ
      Sha Ya|Shā Yǎ
      ## Wang Xiangyang 王向阳 Wáng Xiàngyáng
      Wang Xiang Yang|Wáng Xiàngyáng
      ## Li Qian 李茜 Lǐ Qiàn
      Li Qian|Lǐ Qiàn
      ## Cheng Xinyan 成心妍 Chéng Xīnyán
      Cheng Xin Yan|Chéng Xīnyán
      ## Ouyang Zhen 欧阳贞 Ōuyáng Zhēn
      Ou Yang Zhen|Ōuyáng Zhēn
      ## Professor Zhou 周教授 Zhōu-jiàoshòu
      Professor Zhou|Professor Zhōu
      Teacher Zhou|Teacher Zhōu
      Zhou Jiao Shou|Zhōu-jiàoshòu
      ## Wu Tian'en 吴天恩 Wú Tiān'ēn
      Wu Tian En|Wú Tiān'ēn
      ## Wu Xiaojun 吴晓君 Wú Xiǎojūn
      Wu Xiao Jun|Wú Xiǎojūn
      ## Fourth Uncle 四叔 Sì Shū
      si shu|Sì Shū
      ## Ying Chun 迎春 Yíng Chūn
      Ying Chun|Yíng Chūn
      ## Cong Bo 丛波 Cóng Bō
      Cong Bo|Cóng Bō
      ## Gao Jingfeng 高劲风 Gāo Jìngfēng
      Gao Jing Feng|Gāo Jìngfēng
      ## An Bai 安柏 Ān Bǎi
      An Bai|Ān Bǎi
      ## Ye Huo 野火 Yě Huǒ
      Ye Huo|Yě Huǒ
      ## Da Ji 大吉 Dà Jí
      Da Ji|Dà Jí
      ## Bai Suxia 白素霞 Bái Sùxiá
      Bai Su Xia|Bái Sùxiá
      ## Shen Xi 沈溪 Shěn Xī
      Shen Xi|Shěn Xī
      ## Zhang Shi 獐狮 Zhāng Shī
      Zhang Shi|Zhāng Shī
      ## Chu Nianzhi 楚念之 Chǔ Niànzhī
      Chu Nian Zhi|Chǔ Niànzhī
      ## Guo Changjiang 郭长江 Guō Chángjiāng
      Guo Chang Jiang|Guō Chángjiāng
      ## Guo Xiong 郭雄 Guō Xióng
      Guo Xiong|Guō Xióng
      
      # PLACES
      ## Dragon City (龙城 Lóng chéng)
      Long Cheng|Lóng Chéng
      Long City|Lóng City
      
      # TERMS
      ## Haixing 海星 Hǎixīng
      Hai Xing|Hǎixīng
      ## Dixing 地星(人) Dexīngrén
      Di Xing Ren|Dixīngrén
      Di Xing|Dixīng
      Ya Shou|Yàshòu
      ## Rebel Chieftain 贼酋 zéiqiú
      Zei Qiu|Zéiqiú
      ## Regent  摄政官 shèzhènggūan
      She Zheng Guan|Shèzhènggūan
      `;
}

/**
 * Turn a long replacements string into a list of match objects, where:
 *  - match.words is an array of strings that form the individual words to match
 *  - match.replacement is the text to replace that sequence with
 */
function splitReplacements(replacements) {
  return replacements.split('\n')
      .map(function(line) {
        return line.trim();
      })
      .filter(function(line) {
        return line.length > 0 && !line.startsWith('#');
      })
      .map(function(line) {
        const match = line.split('|');
        return {
          words: match[0].split(' ').filter(match => match.length > 0),
          replacement: match[1].trim()
        };
      });
}

/**
 * Checks for pairs of replacements seq1|replacement1 and seq2|replacement2
 * where seq1|replacement1 comes before seq2|replacement2 in the long list,
 * and seq1 applies a replacement that might prevent seq2 from matching.
 *
 * Example: if 'lan|Lán' is followed by 'Song Lan|Sòng Lán', by the time we try
 * to replace 'song lan' with 'Sòng Lán', the 'lan' in 'song lan' will already
 * have been replaced with 'Lán', and so we'd have to be able to match 'song
 * Lán' in order to replace it with 'Sòng Lán'. This can be fixed by (a)
 * altering the order of the two replacements, e.g. by putting 'lan|Lán' at the
 * very end, or by replacing 'Song Lan|Sòng Lán' with 'Song Lán|Sòng Lán' in
 * order to make sure we still match it after the replacement.
 */
function verifyReplacements(allReplacementsString) {
  const replacements = splitReplacements(allReplacementsString);
  const replacementsSoFar = [];
  for (let i = 0; i < replacements.length; i++) {
    const cur = replacements[i];
    const potentialMatch = cur.words.join('-');
    const conflicts = replacementsSoFar.filter(
        match => potentialMatch.match(
                     new RegExp(wordsMatchRegex(match.words), 'i')) !== null);
    if (conflicts.length > 0) {
      console.log(
          'May have difficulty matching \'' + potentialMatch + '\' (' +
          cur.replacement + '):');
      conflicts.forEach(function(conflict) {
        console.log(
            ' - Conflict with \'' + conflict.words.join('-') + '\' (' +
            conflict.replacement + ')');
      });
    }
    replacementsSoFar.push(cur);
  }
}

/**
 * Use the hard-coded replacement rules string to replace matches with pinyin
 * in the associated doc.
 */
function replaceAll(allReplacementsString) {
  const body = DocumentApp.getActiveDocument().getBody();
  const replacements = splitReplacements(allReplacementsString);
  replacements.forEach(function(element) {
    body.replaceText(
        wordsMatchIgnoreCaseRegex(element.words), element.replacement);
  });
}

/** Function that runs when users use the mdzs menu option. */
function mdzs() {
  // Useful while messing with this script to verify replacement order.
  // Doesn't actually alter the doc.
  verifyReplacements(mdzsReplacements());
  // Replace text in the doc with pinyin!
  replaceAll(mdzsReplacements());
}

/** Function that runs when users use the guardian menu option. */
function guardian() {
  // Useful while messing with this script to verify replacement order.
  // Doesn't actually alter the doc.
  verifyReplacements(guardianReplacements());
  // Replace text in the doc with pinyin!
  replaceAll(guardianReplacements());
}
